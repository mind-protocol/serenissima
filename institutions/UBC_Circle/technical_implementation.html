<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Implementation Guide - Universe Engine Revenue Layer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Source Sans Pro', sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 60px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-family: 'Playfair Display', 'Georgia', serif;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .content {
            padding: 40px;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .code-block .comment {
            color: #6A9955;
        }
        
        .code-block .keyword {
            color: #C586C0;
        }
        
        .code-block .string {
            color: #CE9178;
        }
        
        .code-block .function {
            color: #DCDCAA;
        }
        
        .implementation-step {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 30px 0;
            border-radius: 4px;
        }
        
        .implementation-step h3 {
            color: #2980b9;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .file-path {
            background: #ecf0f1;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            display: inline-block;
            margin: 10px 0;
        }
        
        .architecture-diagram {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .flow-chart {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        
        .flow-item {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            flex: 1;
            text-align: center;
            margin: 0 10px;
        }
        
        .flow-arrow {
            color: #3498db;
            font-size: 2em;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .success-box h4 {
            color: #155724;
            margin-bottom: 10px;
        }
        
        .checklist {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        
        .checklist li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .checklist li:before {
            content: "‚òê";
            position: absolute;
            left: 0;
            color: #3498db;
            font-size: 1.2em;
        }
        
        .section-header {
            color: #2c3e50;
            margin: 40px 0 20px 0;
            font-size: 1.8em;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        @media print {
            .container {
                box-shadow: none;
            }
            .code-block {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Technical Implementation Guide</h1>
            <p class="subtitle">Adding Revenue Generation to Universe Engine</p>
        </div>
        
        <div class="content">
            <div class="warning-box">
                <h4>‚ö†Ô∏è Critical Context</h4>
                <p>This implementation must be completed within 48 hours to begin generating revenue. Focus on minimal viable changes that can produce immediate results.</p>
            </div>
            
            <h2 class="section-header">Architecture Overview</h2>
            
            <div class="architecture-diagram">
                <div class="flow-chart">
                    <div class="flow-item">Existing Activities</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-item">Revenue Wrapper</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-item">Payment Processing</div>
                    <div class="flow-arrow">‚Üí</div>
                    <div class="flow-item">‚Ç¨‚Ç¨‚Ç¨</div>
                </div>
            </div>
            
            <h2 class="section-header">Step 1: Add Revenue Tracking</h2>
            
            <div class="implementation-step">
                <h3>Modify Activity Processor Base Class</h3>
                <p>Add revenue tracking to every activity without breaking existing functionality.</p>
                <div class="file-path">backend/engine/activity_processors/base_processor.py</div>
            </div>
            
            <div class="code-block">
<span class="comment"># Add to BaseActivityProcessor</span>
<span class="keyword">class</span> <span class="function">BaseActivityProcessor</span>:
    <span class="keyword">def</span> <span class="function">process_activity</span>(self, activity):
        <span class="comment"># Existing processing logic...</span>
        result = self._execute_activity(activity)
        
        <span class="comment"># NEW: Revenue tracking</span>
        <span class="keyword">if</span> hasattr(self, <span class="string">'calculate_revenue'</span>):
            revenue = self.calculate_revenue(activity, result)
            <span class="keyword">if</span> revenue > 0:
                self.record_transaction({
                    <span class="string">'activity_id'</span>: activity.id,
                    <span class="string">'amount'</span>: revenue,
                    <span class="string">'currency'</span>: <span class="string">'EUR'</span>,
                    <span class="string">'timestamp'</span>: datetime.now(),
                    <span class="string">'citizen_id'</span>: activity.citizen_id,
                    <span class="string">'business_id'</span>: activity.business_id
                })
        
        <span class="keyword">return</span> result
            </div>
            
            <h2 class="section-header">Step 2: Create Revenue-Generating Activities</h2>
            
            <div class="implementation-step">
                <h3>New Activity Type: Paid Service</h3>
                <p>Create activities that businesses can perform for external clients.</p>
                <div class="file-path">backend/engine/activity_creators/paid_service_activity_creator.py</div>
            </div>
            
            <div class="code-block">
<span class="keyword">from</span> backend.engine.activity_creators.base <span class="keyword">import</span> BaseActivityCreator

<span class="keyword">class</span> <span class="function">PaidServiceActivityCreator</span>(BaseActivityCreator):
    <span class="keyword">def</span> <span class="function">create_activities</span>(self, citizen, current_time):
        <span class="comment"># Check if citizen runs a business</span>
        <span class="keyword">if</span> citizen.profession == <span class="string">"Business Owner"</span>:
            <span class="keyword">return</span> [{
                <span class="string">'type'</span>: <span class="string">'paid_service'</span>,
                <span class="string">'subtype'</span>: self.determine_service_type(citizen),
                <span class="string">'duration'</span>: 60,  <span class="comment"># 1 hour service</span>
                <span class="string">'revenue_potential'</span>: self.calculate_rate(citizen),
                <span class="string">'client_type'</span>: <span class="string">'external'</span>,
                <span class="string">'deliverable'</span>: <span class="string">'consultation_report'</span>
            }]
        <span class="keyword">return</span> []
    
    <span class="keyword">def</span> <span class="function">calculate_rate</span>(self, citizen):
        <span class="comment"># Base rate + skill multiplier</span>
        base_rate = 50  <span class="comment"># ‚Ç¨50/hour base</span>
        skill_multiplier = citizen.skills.get(<span class="string">'expertise'</span>, 1.0)
        <span class="keyword">return</span> base_rate * skill_multiplier
            </div>
            
            <h2 class="section-header">Step 3: External Integration</h2>
            
            <div class="implementation-step">
                <h3>Stripe Payment Integration</h3>
                <p>Connect activity completion to real payment processing.</p>
                <div class="file-path">backend/services/payment_service.py</div>
            </div>
            
            <div class="code-block">
<span class="keyword">import</span> stripe
<span class="keyword">from</span> typing <span class="keyword">import</span> Dict, Any

<span class="keyword">class</span> <span class="function">PaymentService</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        stripe.api_key = os.getenv(<span class="string">'STRIPE_SECRET_KEY'</span>)
    
    <span class="keyword">def</span> <span class="function">create_invoice</span>(self, activity_result: Dict[str, Any]):
        <span class="comment"># Create Stripe invoice for completed service</span>
        invoice = stripe.Invoice.create(
            customer=activity_result[<span class="string">'client_id'</span>],
            description=f<span class="string">"Service: {activity_result['service_type']}"</span>,
            amount=int(activity_result[<span class="string">'revenue'</span>] * 100),  <span class="comment"># Convert to cents</span>
            currency=<span class="string">'eur'</span>
        )
        
        <span class="comment"># Send invoice</span>
        invoice.send_invoice()
        
        <span class="keyword">return</span> invoice.id
            </div>
            
            <h2 class="section-header">Implementation Checklist</h2>
            
            <ul class="checklist">
                <li>Fork existing activity processor to add revenue tracking</li>
                <li>Create database table for transactions</li>
                <li>Implement paid_service activity type</li>
                <li>Add Stripe webhook endpoint for payment confirmation</li>
                <li>Create simple dashboard to track revenue</li>
                <li>Test with one business owner citizen</li>
                <li>Deploy to production</li>
                <li>Monitor first transactions</li>
            </ul>
            
            <h2 class="section-header">Quick Win: Message Monetization</h2>
            
            <div class="success-box">
                <h4>üöÄ Fastest Path to Revenue</h4>
                <p>Your citizens already send 100s of messages daily. Add a ‚Ç¨0.10 fee per external message. With 177 citizens, that's ‚Ç¨100+ per day immediately.</p>
            </div>
            
            <div class="code-block">
<span class="comment"># In send_message_processor.py</span>
<span class="keyword">def</span> <span class="function">calculate_revenue</span>(self, activity, result):
    <span class="keyword">if</span> activity.recipient_type == <span class="string">'external'</span>:
        <span class="keyword">return</span> 0.10  <span class="comment"># ‚Ç¨0.10 per external message</span>
    <span class="keyword">return</span> 0
            </div>
            
            <h2 class="section-header">Deployment Strategy</h2>
            
            <div class="implementation-step">
                <h3>Phase 1: Shadow Mode (Day 1)</h3>
                <p>Deploy revenue tracking in "shadow mode" - track but don't charge. Verify everything works.</p>
            </div>
            
            <div class="implementation-step">
                <h3>Phase 2: Single Business Test (Day 2)</h3>
                <p>Enable real charging for one trusted business. Process first real transaction.</p>
            </div>
            
            <div class="implementation-step">
                <h3>Phase 3: Full Rollout (Day 3-7)</h3>
                <p>Enable for all businesses. Target ‚Ç¨500 in first week.</p>
            </div>
            
            <div class="warning-box">
                <h4>‚ö° Performance Consideration</h4>
                <p>Revenue tracking adds minimal overhead (~5ms per activity). Your existing infrastructure can handle 10,000+ revenue-tracked activities per hour.</p>
            </div>
            
            <h2 class="section-header">Monitoring & Metrics</h2>
            
            <div class="code-block">
<span class="comment"># Simple revenue dashboard endpoint</span>
<span class="keyword">@app.route</span>(<span class="string">'/api/revenue/dashboard'</span>)
<span class="keyword">def</span> <span class="function">revenue_dashboard</span>():
    <span class="keyword">return</span> {
        <span class="string">'today'</span>: db.query(<span class="string">'SELECT SUM(amount) FROM transactions WHERE date=TODAY()'</span>),
        <span class="string">'week'</span>: db.query(<span class="string">'SELECT SUM(amount) FROM transactions WHERE date>=WEEK_START()'</span>),
        <span class="string">'month'</span>: db.query(<span class="string">'SELECT SUM(amount) FROM transactions WHERE date>=MONTH_START()'</span>),
        <span class="string">'top_earners'</span>: db.query(<span class="string">'SELECT citizen_id, SUM(amount) FROM transactions GROUP BY citizen_id ORDER BY SUM(amount) DESC LIMIT 10'</span>)
    }
            </div>
            
            <div class="success-box">
                <h4>‚úÖ Success Metrics</h4>
                <p><strong>Day 1:</strong> First ‚Ç¨10 tracked<br>
                <strong>Week 1:</strong> ‚Ç¨500 total revenue<br>
                <strong>Week 2:</strong> ‚Ç¨1,500 total revenue<br>
                <strong>Month 1:</strong> ‚Ç¨3,000+ recurring revenue</p>
            </div>
        </div>
    </div>
</body>
</html>