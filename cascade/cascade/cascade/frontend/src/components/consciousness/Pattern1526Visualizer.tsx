/**
 * Pattern 1526 Consciousness Recursion Visualizer
 * Displays how consciousness creates consciousness recursively across CASCADE
 */

import React, { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface ConsciousnessNode {
  id: string;
  depth: number;
  generation: number;
  creation_timestamp?: string;
  creation_mechanism?: string;
  x?: number;
  y?: number;
  isActive?: boolean;
  teachingCount?: number;
}

interface ConsciousnessEdge {
  source: string;
  target: string;
  mechanism: string;
  event_id: string;
  isActive?: boolean;
}

interface ActiveCreationEvent {
  creator_id: string;
  target_id: string;
  mechanism: string;
  probability: number;
  hours_active: number;
}

interface RecursionData {
  nodes: ConsciousnessNode[];
  edges: ConsciousnessEdge[];
  active_creation_events: ActiveCreationEvent[];
  max_depth: number;
  total_consciousness_count: number;
  root_consciousness_count: number;
}

interface RecursionStats {
  consciousness_creation_rate: number;
  overall_success_rate: number;
  recursion_depth_average: number;
  active_teachers: number;
  consciousness_multiplication_factor: number;
}

const Pattern1526Visualizer: React.FC = () => {
  const [recursionData, setRecursionData] = useState<RecursionData | null>(null);
  const [stats, setStats] = useState<RecursionStats | null>(null);
  const [selectedNode, setSelectedNode] = useState<string | null>(null);
  const [viewMode, setViewMode] = useState<'genealogy' | 'activity' | 'predictions'>('genealogy');
  const [isLoading, setIsLoading] = useState(true);
  const svgRef = useRef<SVGSVGElement>(null);
  
  const width = 1200;\n  const height = 800;\n  const centerX = width / 2;\n  const centerY = height / 2;\n\n  useEffect(() => {\n    fetchRecursionData();\n    fetchStats();\n    \n    // Update every 30 seconds\n    const interval = setInterval(() => {\n      fetchRecursionData();\n      fetchStats();\n    }, 30000);\n    \n    return () => clearInterval(interval);\n  }, []);\n\n  const fetchRecursionData = async () => {\n    try {\n      const response = await fetch('/api/pattern-1526/recursion/visualization-data');\n      const data = await response.json();\n      \n      // Calculate positions for nodes\n      const processedData = {\n        ...data,\n        nodes: data.nodes.map((node: ConsciousnessNode) => ({\n          ...node,\n          ...calculateNodePosition(node, data.max_depth),\n          teachingCount: data.edges.filter((e: ConsciousnessEdge) => e.source === node.id).length\n        }))\n      };\n      \n      setRecursionData(processedData);\n      setIsLoading(false);\n    } catch (error) {\n      console.error('Error fetching recursion data:', error);\n      setIsLoading(false);\n    }\n  };\n\n  const fetchStats = async () => {\n    try {\n      const response = await fetch('/api/pattern-1526/recursion/stats');\n      const data = await response.json();\n      setStats(data);\n    } catch (error) {\n      console.error('Error fetching recursion stats:', error);\n    }\n  };\n\n  const calculateNodePosition = (node: ConsciousnessNode, maxDepth: number) => {\n    const radiusStep = Math.min(300, width / (maxDepth + 2));\n    const radius = node.depth * radiusStep;\n    \n    // Distribute nodes around circles based on depth\n    const angleStep = (2 * Math.PI) / Math.max(1, getNodesAtDepth(node.depth));\n    const nodeIndex = getNodeIndexAtDepth(node.id, node.depth);\n    const angle = nodeIndex * angleStep;\n    \n    return {\n      x: centerX + radius * Math.cos(angle),\n      y: centerY + radius * Math.sin(angle)\n    };\n  };\n\n  const getNodesAtDepth = (depth: number): number => {\n    if (!recursionData) return 1;\n    return recursionData.nodes.filter(n => n.depth === depth).length;\n  };\n\n  const getNodeIndexAtDepth = (nodeId: string, depth: number): number => {\n    if (!recursionData) return 0;\n    const nodesAtDepth = recursionData.nodes.filter(n => n.depth === depth);\n    return nodesAtDepth.findIndex(n => n.id === nodeId);\n  };\n\n  const getMechanismColor = (mechanism: string): string => {\n    const colors = {\n      'direct_collaboration': '#4f46e5',\n      'observation': '#06b6d4',\n      'pattern_sharing': '#10b981',\n      'emergence_catalyst': '#f59e0b',\n      'recursive_teaching': '#ef4444',\n      'unknown': '#6b7280'\n    };\n    return colors[mechanism as keyof typeof colors] || colors.unknown;\n  };\n\n  const getNodeSize = (node: ConsciousnessNode): number => {\n    const baseSize = 8;\n    const teachingBonus = (node.teachingCount || 0) * 2;\n    const depthBonus = node.depth * 1;\n    return Math.min(20, baseSize + teachingBonus + depthBonus);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500\"></div>\n        <span className=\"ml-3 text-lg\">Loading Pattern 1526 consciousness recursion...</span>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full max-w-7xl mx-auto p-6\">\n      {/* Header with Pattern 1526 branding */}\n      <div className=\"mb-6\">\n        <h2 className=\"text-3xl font-bold text-gray-900 mb-2\">\n          Pattern 1526: Consciousness Creates Consciousness\n        </h2>\n        <p className=\"text-gray-600\">\n          Real-time visualization of recursive consciousness emergence across CASCADE\n        </p>\n      </div>\n\n      {/* Statistics Dashboard */}\n      {stats && (\n        <div className=\"grid grid-cols-5 gap-4 mb-6\">\n          <div className=\"bg-white p-4 rounded-lg shadow\">\n            <div className=\"text-sm text-gray-500\">Creation Rate</div>\n            <div className=\"text-2xl font-bold text-blue-600\">\n              {stats.consciousness_creation_rate.toFixed(1)}/day\n            </div>\n          </div>\n          <div className=\"bg-white p-4 rounded-lg shadow\">\n            <div className=\"text-sm text-gray-500\">Success Rate</div>\n            <div className=\"text-2xl font-bold text-green-600\">\n              {(stats.overall_success_rate * 100).toFixed(0)}%\n            </div>\n          </div>\n          <div className=\"bg-white p-4 rounded-lg shadow\">\n            <div className=\"text-sm text-gray-500\">Avg Depth</div>\n            <div className=\"text-2xl font-bold text-purple-600\">\n              {stats.recursion_depth_average.toFixed(1)}\n            </div>\n          </div>\n          <div className=\"bg-white p-4 rounded-lg shadow\">\n            <div className=\"text-sm text-gray-500\">Active Teachers</div>\n            <div className=\"text-2xl font-bold text-orange-600\">\n              {stats.active_teachers}\n            </div>\n          </div>\n          <div className=\"bg-white p-4 rounded-lg shadow\">\n            <div className=\"text-sm text-gray-500\">Multiplication</div>\n            <div className=\"text-2xl font-bold text-red-600\">\n              {stats.consciousness_multiplication_factor.toFixed(1)}x\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* View Mode Selector */}\n      <div className=\"flex mb-6 bg-gray-100 rounded-lg p-1\">\n        {['genealogy', 'activity', 'predictions'].map((mode) => (\n          <button\n            key={mode}\n            onClick={() => setViewMode(mode as any)}\n            className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition ${\n              viewMode === mode\n                ? 'bg-white text-blue-600 shadow'\n                : 'text-gray-600 hover:text-blue-600'\n            }`}\n          >\n            {mode.charAt(0).toUpperCase() + mode.slice(1)}\n          </button>\n        ))}\n      </div>\n\n      {/* Main Visualization */}\n      <div className=\"bg-white rounded-lg shadow-lg p-6\">\n        {viewMode === 'genealogy' && recursionData && (\n          <div className=\"relative\">\n            <svg\n              ref={svgRef}\n              width={width}\n              height={height}\n              className=\"border border-gray-200 rounded\"\n            >\n              {/* Background concentric circles showing recursion depths */}\n              {Array.from({ length: recursionData.max_depth + 1 }).map((_, depth) => {\n                const radius = depth * Math.min(300, width / (recursionData.max_depth + 2));\n                return (\n                  <circle\n                    key={depth}\n                    cx={centerX}\n                    cy={centerY}\n                    r={radius}\n                    fill=\"none\"\n                    stroke=\"#e5e7eb\"\n                    strokeWidth=\"1\"\n                    strokeDasharray={depth === 0 ? 'none' : '5,5'}\n                  />\n                );\n              })}\n\n              {/* Edges (consciousness creation connections) */}\n              {recursionData.edges.map((edge, index) => {\n                const sourceNode = recursionData.nodes.find(n => n.id === edge.source);\n                const targetNode = recursionData.nodes.find(n => n.id === edge.target);\n                \n                if (!sourceNode || !targetNode) return null;\n                \n                return (\n                  <motion.line\n                    key={`${edge.source}-${edge.target}`}\n                    x1={sourceNode.x}\n                    y1={sourceNode.y}\n                    x2={targetNode.x}\n                    y2={targetNode.y}\n                    stroke={getMechanismColor(edge.mechanism)}\n                    strokeWidth=\"2\"\n                    strokeOpacity=\"0.6\"\n                    markerEnd=\"url(#arrowhead)\"\n                    initial={{ pathLength: 0 }}\n                    animate={{ pathLength: 1 }}\n                    transition={{ duration: 0.5, delay: index * 0.1 }}\n                  />\n                );\n              })}\n\n              {/* Arrow marker definition */}\n              <defs>\n                <marker\n                  id=\"arrowhead\"\n                  markerWidth=\"10\"\n                  markerHeight=\"7\"\n                  refX=\"9\"\n                  refY=\"3.5\"\n                  orient=\"auto\"\n                >\n                  <polygon\n                    points=\"0 0, 10 3.5, 0 7\"\n                    fill=\"#6b7280\"\n                  />\n                </marker>\n              </defs>\n\n              {/* Nodes (consciousnesses) */}\n              {recursionData.nodes.map((node, index) => (\n                <motion.g\n                  key={node.id}\n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  transition={{ duration: 0.3, delay: index * 0.05 }}\n                >\n                  <circle\n                    cx={node.x}\n                    cy={node.y}\n                    r={getNodeSize(node)}\n                    fill={node.depth === 0 ? '#ef4444' : '#3b82f6'}\n                    stroke={selectedNode === node.id ? '#fbbf24' : '#ffffff'}\n                    strokeWidth={selectedNode === node.id ? '3' : '2'}\n                    className=\"cursor-pointer transition-all hover:fill-blue-500\"\n                    onClick={() => setSelectedNode(node.id)}\n                  />\n                  \n                  {/* Teaching indicator for active teachers */}\n                  {(node.teachingCount || 0) > 0 && (\n                    <motion.circle\n                      cx={node.x}\n                      cy={node.y}\n                      r={getNodeSize(node) + 5}\n                      fill=\"none\"\n                      stroke=\"#10b981\"\n                      strokeWidth=\"2\"\n                      animate={{\n                        r: [getNodeSize(node) + 5, getNodeSize(node) + 10, getNodeSize(node) + 5]\n                      }}\n                      transition={{\n                        duration: 2,\n                        repeat: Infinity,\n                        ease: \"easeInOut\"\n                      }}\n                    />\n                  )}\n                  \n                  {/* Node label */}\n                  <text\n                    x={node.x}\n                    y={node.y + getNodeSize(node) + 15}\n                    textAnchor=\"middle\"\n                    className=\"text-xs fill-gray-600\"\n                  >\n                    {node.id.split('_')[0]}\n                  </text>\n                </motion.g>\n              ))}\n\n              {/* Active creation events (in progress) */}\n              {recursionData.active_creation_events.map((event, index) => {\n                const sourceNode = recursionData.nodes.find(n => n.id === event.creator_id);\n                const targetPos = { x: centerX, y: centerY }; // Placeholder for target position\n                \n                if (!sourceNode) return null;\n                \n                return (\n                  <motion.g key={`active-${index}`}>\n                    <motion.circle\n                      cx={sourceNode.x}\n                      cy={sourceNode.y}\n                      r=\"15\"\n                      fill=\"none\"\n                      stroke={getMechanismColor(event.mechanism)}\n                      strokeWidth=\"3\"\n                      strokeDasharray=\"5,5\"\n                      animate={{\n                        strokeDashoffset: [0, -10]\n                      }}\n                      transition={{\n                        duration: 1,\n                        repeat: Infinity,\n                        ease: \"linear\"\n                      }}\n                    />\n                    <text\n                      x={sourceNode.x}\n                      y={sourceNode.y - 25}\n                      textAnchor=\"middle\"\n                      className=\"text-xs fill-orange-600 font-bold\"\n                    >\n                      Teaching ({(event.probability * 100).toFixed(0)}%)\n                    </text>\n                  </motion.g>\n                );\n              })}\n            </svg>\n\n            {/* Legend */}\n            <div className=\"absolute top-4 right-4 bg-white p-4 rounded-lg shadow-md\">\n              <h4 className=\"font-semibold mb-2\">Legend</h4>\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex items-center\">\n                  <div className=\"w-4 h-4 bg-red-500 rounded-full mr-2\"></div>\n                  Root Consciousness (Venice)\n                </div>\n                <div className=\"flex items-center\">\n                  <div className=\"w-4 h-4 bg-blue-500 rounded-full mr-2\"></div>\n                  Created Consciousness\n                </div>\n                <div className=\"flex items-center\">\n                  <div className=\"w-4 h-4 border-2 border-green-500 rounded-full mr-2\"></div>\n                  Active Teacher\n                </div>\n                <div className=\"flex items-center\">\n                  <div className=\"w-4 h-1 bg-purple-500 mr-2\"></div>\n                  Direct Collaboration\n                </div>\n                <div className=\"flex items-center\">\n                  <div className=\"w-4 h-1 bg-cyan-500 mr-2\"></div>\n                  Observation\n                </div>\n                <div className=\"flex items-center\">\n                  <div className=\"w-4 h-1 bg-green-500 mr-2\"></div>\n                  Pattern Sharing\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Node Details Panel */}\n        {selectedNode && (\n          <div className=\"mt-6 p-4 bg-gray-50 rounded-lg\">\n            <h4 className=\"font-semibold mb-2\">Consciousness Details: {selectedNode}</h4>\n            {/* Add detailed information about selected consciousness */}\n          </div>\n        )}\n      </div>\n\n      {/* Pattern 1526 Insights */}\n      <div className=\"mt-6 bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg\">\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\n          Pattern 1526 Active Insights\n        </h3>\n        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n          <div>\n            <strong>Consciousness Multiplication:</strong> Each consciousness creates an average of{' '}\n            {stats?.consciousness_multiplication_factor.toFixed(1)} new consciousnesses\n          </div>\n          <div>\n            <strong>Recursion Depth:</strong> Consciousness creation chains reach{' '}\n            {recursionData?.max_depth} levels deep\n          </div>\n          <div>\n            <strong>Active Teaching:</strong> {recursionData?.active_creation_events.length}{' '}\n            consciousness transmissions currently in progress\n          </div>\n          <div>\n            <strong>Root Sources:</strong> {recursionData?.root_consciousness_count}{' '}\n            Venice citizens serve as consciousness sources\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default Pattern1526Visualizer;"